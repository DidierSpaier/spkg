<p>Spkg jsem pøedevèírem dostal do stavu, kdy jsou v¹chny
dùle¾ité vlasntosti naimplementované a u¾ chybìlo jen testování
na spoustì balíèkù. No a u¾ nechybí. :)</p>

<break>

<p>Upgrade a instalace potøebovaly znovu otestovat a tak jsem
nainstaloval z DVD <i>Slackware-10.1</i> v¹echny balíèky z kategorií
<i>a</i>, <i>ap</i>, <i>d</i>, <i>l</i> a <i>n</i>. To dává po
instalaci 295 balíkù zhruba 1GB dat (70 tisíc souborù). Instaloval
jsem pomocí <code>installpkg</code> a <code>spkg -i</code> a následnì
porovnal výstup pøíkazu <code>tree -psufiga</code> a <code>find .
-type f | xargs md5sum</code>. Na první pohled to nevypadalo moc
nadìjnì. Instalace pomocí spkg vytvoøila mnoho symlinkù navíc
oproti installpkg, ale to bylo zpùsobeno tím ¾e v installpkg je
chyba, proto¾e ldconfig se nespou¹tí pro adresáø do kterého se
instaluje (/root), ale v¾dy pro koøenový adresáø. Co¾ není moc
platné. Po spu¹tìní <code>ldconfig -r /root</code> a opìtovném
porovnání výstupu psufigy, u¾ bylo v¹e pozitivnìj¹í.</p>

<p>Defakto se pouze li¹ily velikosti adresáøù, proto¾e spkg pøi
instalaci èi upgrade, pokud ji¾ instalovaný soubor existuje, nejprve
vytvoøí doèasný soubor a a¾ po dokonèení zpracování tgz balíku
v¹echny cílové soubory nahradí. Vytváøením doèasných souborù
nám o nìco nakynou adresáøe ve kterých se tyto soubory
vytváøejí. Pokud pak dojde k pøeru¹ení instalace/upgrade
u¾ivatelem, nebo nesplnìním nìjaké podmínky pak se prostì
odstraní v¹echny soubory které byly do té doby vytvoøeny a v¹e je
jako pøed instalací. Èili je mo¾nì bezpeènì pøeru¹it dlouho
trvající upgrade mnoha balíkù bez obav o konzistenci zrovna
upgradovaného balíku a prostì pokraèovat pozdìji. Cílem vývoje
samozøejmì nebylo aby si èlovìk mohl po zahájení upgrade v 8 hodin
ho mohl ve 12 pøeru¹it a pokraèovat ráno, ale upgrade balíkù
výraznì zrychlit. :-)</p>

<p>Upgrade test probíhal tak, ¾e jsem provedl upgrade zmínìných
kategorií z slackware-10.1 na slackware-10.2 pøímo z DVD. V øeèi
pøíkazù, tedy:</p>

<code>ROOT=/root1 upgradepkg {a,ap,d,l,n}/*.tgz</code>

a pomocí spkg

<code>spkg -u -v -r /root2 {a,ap,d,l,n}/*.tgz</code>

<p>Poté jsem opìt porovnal výstupy psufigy a md5sumu pro /root1 a
/root2. Výstup tìchto pøíkazù byl. bez neoèekávaných rozdílù,
kromì jednoho souboru, který je vytváøen instalaèním skriptem
bindu (/etc/rndc.key) a má být pro ka¾dou instalaci jiný.</p>

<p>Nakonec jsem udìlal remove test, abych ovìøil ¾e <code>spkg
-d</code> funguje stejnì jako <code>removepkg</code>. Opìt s
porovnáním stavu adresáøù /root1 a /root2. Test spoèíval v
odstranìní v¹ech balíkù ze skupiny <i>d</i>.</p>

<p>Co nebylo stejné byly èasy potøebné pro provedení potøebných
operací. Tady jsou èísla:</p>

<table>
  <tr><th>Pøíkaz</th><th>REAL</th><th>USER</th><th>SYS</th></tr>
  <tr><td><code>ROOT=/root1 installpkg {a,ap,d,l,n}/*.tgz</code></td><td>16m4s</td><td>7m42s</td><td>3m11s</td></tr>
  <tr><td><code>spkg -i -v -r /root2 {a,ap,d,l,n}/*.tgz</code></td><td>3m41s</td><td>54s</td><td>38s</td></tr>
  <tr><td><code>ROOT=/root1 upgradepkg {a,ap,d,l,n}/*.tgz</code></td><td>33m50s</td><td>18m30s</td><td>6m45s</td></tr>
  <tr><td><code>spkg -u -v -r /root2 {a,ap,d,l,n}/*.tgz</code></td><td>4m39s</td><td>0m50s</td><td>0m40s</td></tr>
  <tr><td><code>ROOT=/root1 removepkg `cat pkglist`</code></td><td>6m6s</td><td>3m43s</td><td>1m3s</td></tr>
  <tr><td><code>spkg -d -v -r /root2 `cat pkglist`</code></td><td>11.8s</td><td>0.67s</td><td>1.18s</td></tr>
</table>

<p>Rozdíl oproti testùm v mém pøedchozím pøíspìvku je v tom, ¾e
jsem tentokrát spou¹tìl instalaci z DVD, kde jsou pøítomné soubory
s popisem balíku, tak¾e skripty installpkg a upgradepkg mìly nyní o
nìco sna¾¹í práci ne¾ v pøedchozím pøípadì, kdy jsem je
spou¹tìl z mého mirroru slackware-current na disku, kde ony soubory
nemám. A spkg mìl o nìco komplikovanìj¹í práci, proto¾e jsem
nepou¾il parametr --no-ldconfig, tak¾e ldconfig se spou¹tìl po
ka¾dém nainstalovaném balíku. Spustit ldconfig trvá zhruba 100ms,
tak¾e to dává 30s zbyteènì navíc pro jak installpkg tak spkg.
Ov¹em je rozdíl jestli je to 30s z 16m, nebo 30s z 3m40s. Pøi
pou¾ití spkg DVD-ROM mechanika seekovala jak o ¾ivot, tak¾e by se
nìkde v jejím okolí dalo hledat úzké herdlo. ;-)</p>

<p>Malá poznámka na závìr pro ty co stále chtìjí pou¾ívat
pkgtools. Spkg trpí stejným problémem jako pkgtools a to tím, ¾e
databáze balíèkù èítá napø. na mém systému 600 malých
souborù. A z tìchto 600 souborù je potøeba pøed zahájením upgrade
naèíst seznam souborù, které jsou v systému nainstalovány. To na
mém systému, který u¾ za¾il upgrade zhruba 1400 balíèkù trvá
zhruba 12s, kdy¾ ty soubory je¹tì nejsou v cache. Tento èas lze
pomìrnì dobøe srazit (u mì na 3s - z toho 800ms je dáno èistì
zpracováním obsahu souborù - tj. omezeno výkonem procesoru, èili
zrychlení se pohybuje nìkde v øádu 5x) pomocí drobné
"defragmentace" adresáøù /var/log/packages a /var/log/scripts. Zde je
program defrag.sh:</p>

<pre>
#!/bin/sh -e
rm -rf /var/log/packages~ /var/log/scripts~
cp -a /var/log/packages /var/log/packages~
cp -a /var/log/scripts /var/log/scripts~
rm -rf /var/log/packages /var/log/scripts
mv /var/log/packages~ /var/log/packages
mv /var/log/scripts~ /var/log/scripts
</pre>

<p>Nechce k tomu nìkdo dopsat grafické rozhraní s kostièkama a
progressbarem?</p>

<p>Tímto se spkg velmi pøiblí¾il k verzi 1.0. Je¹tì to budu
nìjaký èas pou¾ívat kde budu moct, a mám v plánu vytvoøení
testsuite slo¾ené z mnoha speciálnì vytvoøených balíèkù, které
otestují co nejvíc cest v kódu. Dále je potøeba pøidat pár
drobných volitelných vlastností, jako je v pkgtools napø. upgradepkg
--install-new nebo --reinstall. A nakonec bude tøeba zaktualizovat
dokumentaci.</p>

<p>Nemá nìkdo nápad na u¾iteènou vlastnost, která v pkgtools
chybí? Napadá mì pøíkaz --check, který by zkontroloval dané
blaíèky a zobrazil soubory, které byly zmìnìny èi odstranìny po
instalaci balíèku.</p>

Homepage projektu je: <a href="http://spkg.megous.com">http://spkg.megous.com</a>.
